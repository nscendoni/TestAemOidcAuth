version: '3.1'
services:
  # ==========================================================================
  # Keycloak - Identity Provider (IdP)
  # ==========================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:26.4.6
    container_name: keycloak
    command: start-dev --import-realm
    ports:
      - "8081:8080"
    volumes:
      - ./keycloak:/opt/keycloak/data
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK' || exit 0"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  # ==========================================================================
  # AEM Publish Instance
  # ==========================================================================
  aem-publish:
    build:
      context: .
      dockerfile: Dockerfile.aem
    container_name: aem-publish
    # entrypoint: tail -f /dev/null
    ports:
      - "4503:4503"
      - "5006:5006"
    environment:
      - MODE=publish
      - PORT=4503
      - DEBUG_PORT=5006
      - KEYCLOAK_URL=${KEYCLOAK_URL:-http://keycloak:8080}
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD-admin}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM-sling}
      - KEYCLOAK_SAML_CLIENT_ID=${KEYCLOAK_SAML_CLIENT_ID-test-saml}
      - AEM_PUBLISH_URL=http://localhost:4503
      - CERT_DIR=/opt/aem/certs
      - OPENSSL_PASS=${OPENSSL_PASS-admin}
      - MAVEN_REPOSITORY=/var/cache/maven
    volumes:
      - ~/.m2:/var/cache/maven
      - .:/var/cache/contents
      - ${AEM_QUICKSTART}:/opt/aem/cq-quickstart.jar
      - ./docker-entrypoint.sh:/opt/aem/docker-entrypoint.sh
      - ./saml_setup.sh:/opt/aem/saml_setup.sh
    depends_on:
      keycloak:
        condition: service_healthy

  # ==========================================================================
  # Dispatcher (Apache + Dispatcher Module)
  # ==========================================================================
  dispatcher:
    image: adobe/aem-cs/dispatcher-publish:2.0.258
    container_name: dispatcher
    ports:
      - "8085:80"
    environment:
      - AEM_PORT=4503
      - AEM_HOST=aem-publish
      - DISP_LOG_LEVEL=debug
      - ALLOW_CACHE_INVALIDATION_GLOBALLY=true
    volumes:
      - ./dispatcher/src/conf.dispatcher.d/dispatcher.any:/etc/httpd/conf.dispatcher.d/dispatcher.any
      - ./dispatcher/src/conf.dispatcher.d/virtualhosts/default_virtualhosts.any:/etc/httpd/conf.dispatcher.d/virtualhosts/default_virtualhosts.any
      - ./dispatcher/src/conf.dispatcher.d/virtualhosts/virtualhosts.any:/etc/httpd/conf.dispatcher.d/virtualhosts/virtualhosts.any
      - ./dispatcher/src/conf.dispatcher.d/enabled_farms/README:/etc/httpd/conf.dispatcher.d/enabled_farms/README
      - ./dispatcher/src/conf.dispatcher.d/enabled_farms/default.farm:/etc/httpd/conf.dispatcher.d/enabled_farms/default.farm
      - ./dispatcher/src/conf.dispatcher.d/clientheaders/default_clientheaders.any:/etc/httpd/conf.dispatcher.d/clientheaders/default_clientheaders.any
      - ./dispatcher/src/conf.dispatcher.d/clientheaders/clientheaders.any:/etc/httpd/conf.dispatcher.d/clientheaders/clientheaders.any
      - ./dispatcher/src/conf.dispatcher.d/cache/rules.any:/etc/httpd/conf.dispatcher.d/cache/rules.any
      - ./dispatcher/src/conf.dispatcher.d/cache/default_rules.any:/etc/httpd/conf.dispatcher.d/cache/default_rules.any
      - ./dispatcher/src/conf.dispatcher.d/cache/default_invalidate.any:/etc/httpd/conf.dispatcher.d/cache/default_invalidate.any:ro
      - ./dispatcher/src/conf.dispatcher.d/renders/default_renders.any:/etc/httpd/conf.dispatcher.d/renders/default_renders.any
      - ./dispatcher/src/conf.dispatcher.d/filters/filters.any:/etc/httpd/conf.dispatcher.d/filters/filters.any
      - ./dispatcher/src/conf.dispatcher.d/filters/default_filters.any:/etc/httpd/conf.dispatcher.d/filters/default_filters.any
      - ./dispatcher/src/conf.dispatcher.d/available_farms/default.farm:/etc/httpd/conf.dispatcher.d/available_farms/default.farm
      - ./dispatcher/src/conf.d/available_vhosts/wintergw2025.vhost:/etc/httpd/conf.d/available_vhosts/default.vhost
      - ./dispatcher/src/conf.d/available_vhosts/wintergw2025.vhost:/etc/httpd/conf.d/available_vhosts/wintergw2025.vhost
      - ./dispatcher/src/conf.d/enabled_vhosts/README:/etc/httpd/conf.d/enabled_vhosts/README
      - ./dispatcher/src/conf.d/available_vhosts/wintergw2025.vhost:/etc/httpd/conf.d/enabled_vhosts/default.vhost
      - ./dispatcher/src/conf.d/variables/custom.vars:/etc/httpd/conf.d/variables/custom.vars
      - ./dispatcher/src/conf.d/variables/global.vars:/etc/httpd/conf.d/variables/global.vars
      - ./dispatcher/src/conf.d/dispatcher_vhost.conf:/etc/httpd/conf.d/dispatcher_vhost.conf
      - ./dispatcher/src/conf.d/rewrites/default_rewrite.rules:/etc/httpd/conf.d/rewrites/default_rewrite.rules
      - ./dispatcher/src/conf.d/rewrites/rewrite.rules:/etc/httpd/conf.d/rewrites/rewrite.rules
      - ./dispatcher/src/htdocs/error-500.html:/var/www/html/default/error-500.html
    depends_on:
      - aem-publish
